<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="assets/hfsrb-logo.png">
  <link rel="apple-touch-icon" href="assets/hfsrb-logo.png">
  <meta property="og:title" content="HFSRB Facility Survey">
  <meta property="og:description" content="Explore Illinois facility profiles by type and year.">
  <meta property="og:image" content="assets/hfsrb-logo.png">
  <meta name="twitter:card" content="summary_large_image">
  <title>HFSRB Survey | Welcome</title>
  <link rel="stylesheet" href="brand.css">
  <style>
    :root { --bg:#f7f9fc; --card:#ffffff; --fg:#0b1220; --muted:#5f6b7a; --accent:#28658D; --border:#e5eaf1; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin:0; background: radial-gradient(900px 360px at 50% -20%, #eef3ff 0%, transparent 60%), linear-gradient(180deg,#f9fbff, #f4f7fb); color: var(--fg); display:grid; place-items:center; }
    .wrap { width: min(920px, 92vw); padding: 22px; border: 1px solid var(--border); border-radius: 14px; background: var(--card); box-shadow: 0 8px 24px rgba(16,24,40,0.08); }
    .head { display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom: 8px; text-align:center; }
    h1 { margin: 0; font-size: 22px; letter-spacing: 0.2px; }
    .sub { margin: 4px 0 14px; color: var(--muted); }
    label { font-size: 12px; color: var(--muted); }
    .form { display:grid; gap:10px; grid-template-columns: 1fr; }
    @media (min-width: 880px) { .form { grid-template-columns: 1fr 1fr 1fr; } }
    .field { display:flex; flex-direction:column; gap:5px; }
    select, input[type=text] { appearance: none; -webkit-appearance:none; -moz-appearance:none; width: 100%; padding: 9px 12px; border-radius: 8px; border: 1px solid var(--border); background: #fafcff; color: var(--fg); font-size: 14px; box-shadow: inset 0 0 0 1px rgba(40,101,141,0.05); }
    .row-aux { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top: 6px; }
    .count { font-size: 12px; color: var(--muted); }
    .cta { display:flex; gap:8px; flex-wrap: wrap; }
    .btn { padding: 9px 12px; border-radius: 8px; border: 1px solid var(--border); background: linear-gradient(180deg, #ffffff, #f5f8ff); color: #0b1220; cursor: pointer; font-weight: 600; letter-spacing: .2px; }
    .btn.primary { background: linear-gradient(180deg, #2f82b3, #28658D); color: #fff; border-color: #28658D; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .hint { font-size: 12px; color: var(--muted); margin-top: 6px; }
  </style>
</head>
<body>
  <main class="wrap">
    <div class="head">
      <h1 class="brand"><img class="brand-logo" src="assets/hfsrb-logo.png" srcset="assets/hfsrb-logo.png 1x, assets/hfsrb-logo@2x.png 2x" alt="HFSRB logo" onerror="this.onerror=null;this.src='assets/hfsrb-logo.svg';"> Explore Illinois Facility Survey <span class="version">v10</span></h1>
    </div>
    <p class="sub">Pick a facility type and year, then jump right into a full profile.</p>
    <div id="chips" class="chips" style="margin-bottom:6px"></div>
    <div class="form">
      <div class="field">
        <label for="type">Facility Type</label>
        <select id="type">
          <option value="" disabled selected>Select a type…</option>
          <option>Hospital</option>
          <option>ASTC</option>
          <option>ESRD</option>
          <option>LTC</option>
        </select>
      </div>
      <div class="field" id="step-year">
        <label for="year">Year</label>
        <select id="year"></select>
      </div>
      <div class="field" id="step-fac">
        <label for="facility">Facility</label>
        <input id="facFilter" type="text" placeholder="Type to filter facilities…">
        <select id="facility"></select>
      </div>
    </div>
    <div class="row-aux">
      <div class="count" id="facCount"></div>
      <div class="cta">
        <button class="btn primary" id="openBtn" disabled>Open Profile</button>
        <a class="btn" href="dashboard.html">Advanced Dashboard</a>
        <a class="btn" href="query.html">Query Assistant</a>
      </div>
    </div>
  </main>

  <script>
    const IS_WEB_SUBDIR = window.location.pathname.includes('/web/');
    const api = {
      async loadIndex() {
        const res = await fetch((IS_WEB_SUBDIR ? '' : '') + 'data/index.json?v=2');
        return await res.json();
      }
    };
    const el = (s) => document.querySelector(s);
    const state = { all: [], choices: { type:'', year:'', slug:'' }, facFilter: '' };
    const RECENT_KEY = 'hfsrb_recent_profiles';
    function pushRecent(row){
      try{
        const rec = JSON.parse(localStorage.getItem(RECENT_KEY)||'[]');
        const entry = { year: row.year, type: row.type, slug: row.slug, name: row.name };
        const filtered = rec.filter(r => !(r.year==entry.year && r.type==entry.type && r.slug==entry.slug));
        filtered.unshift(entry);
        localStorage.setItem(RECENT_KEY, JSON.stringify(filtered.slice(0,8)));
      }catch{}
    }
    function renderRecent(){
      try{
        const box = document.createElement('div'); box.id='recentWrap'; box.className='recent';
        const anchor = document.querySelector('.cta'); if (!anchor) return;
        const rec = JSON.parse(localStorage.getItem(RECENT_KEY)||'[]');
        if (!rec.length) return;
        box.innerHTML = rec.map(r=>`<button class="chip" data-year="${r.year}" data-type="${r.type}" data-slug="${r.slug}">${r.name}</button>`).join('');
        anchor.insertAdjacentElement('afterend', box);
        box.querySelectorAll('.chip').forEach(ch => ch.addEventListener('click', () => {
          const y = ch.getAttribute('data-year'); const t = ch.getAttribute('data-type'); const s = ch.getAttribute('data-slug');
          window.location.href = `./out/profiles/${y}/${t}/${s}.html?show=all`;
        }));
      }catch{}
    }
    function setYears() {
      const ysel = el('#year'); const stp = el('#step-year');
      const years = [...new Set(state.all.filter(r => !state.choices.type || r.type===state.choices.type).map(r => r.year))]
        .filter(Boolean).sort((a,b)=>b-a);
      ysel.innerHTML = '<option value="" disabled selected>Select a year…</option>' + years.map(y=>`<option>${y}</option>`).join('');
      stp.classList.toggle('hidden', years.length===0);
    }
    
    function updateChips(){
      const box = el('#chips'); if (!box) return;
      const parts = [];
      if (state.choices.type) parts.push(`<span class="chip" data-k="type">Type: ${state.choices.type} ×</span>`);
      if (state.choices.year) parts.push(`<span class="chip" data-k="year">Year: ${state.choices.year} ×</span>`);
      if (state.facFilter) parts.push(`<span class="chip" data-k="filter">Filter: ${state.facFilter} ×</span>`);
      box.innerHTML = parts.join(' ');
      box.querySelectorAll('.chip').forEach(ch => ch.addEventListener('click', () => {
        const k = ch.getAttribute('data-k');
        if (k==='type'){ state.choices.type=''; const ts=el('#type'); if(ts) ts.value=''; setYears(); state.choices.year=''; const ys=el('#year'); if(ys) ys.innerHTML=''; }
        if (k==='year'){ state.choices.year=''; const ys=el('#year'); if(ys) ys.value=''; }
        if (k==='filter'){ state.facFilter=''; const fi = el('#facFilter'); if (fi) fi.value=''; }
        setFacilities(); el('#openBtn').disabled = true;
      }));
    }
    function setFacilities() {
      const fes = el('#facility'); const stp = el('#step-fac'); const cnt = el('#facCount'); const filt = (state.facFilter||'').toLowerCase();
      let rows = state.all.filter(r => (!state.choices.type || r.type===state.choices.type) && (!state.choices.year || String(r.year)===String(state.choices.year)));
      if (filt) rows = rows.filter(r => `${r.name} ${r.city||''} ${r.zip||''}`.toLowerCase().includes(filt));
      const opts = rows.sort((a,b)=> a.name.localeCompare(b.name)).map(r => `<option value="${r.slug}">${r.name}${r.city?` — ${r.city}`:''}</option>`).join('');
      fes.innerHTML = '<option value="" disabled selected>Select a facility…</option>' + opts;
      stp.classList.toggle('hidden', rows.length===0);
      cnt.textContent = rows.length ? `${rows.length} facilities${filt?` • filtered by “${state.facFilter}”`:''}` : (filt ? 'No matches' : '');
      updateChips();
    }
    function openProfile() {
      const { type, year, slug } = state.choices;
      if (!type || !year || !slug) return;
      const base = IS_WEB_SUBDIR ? '.' : '.';
      const url = `${base}/out/profiles/${year}/${type}/${slug}.html?show=all`;
      try { const row = state.all.find(r => r.type===type && String(r.year)===String(year) && r.slug===slug); if (row) pushRecent(row); } catch {}
      window.location.href = url;
    }
    (async function init(){
      state.all = await api.loadIndex();
      // Wire selects
      const tSel = el('#type'); const ySel = el('#year'); const fInp = el('#facFilter'); const fSel = el('#facility');
      function updateDisabled(){ ySel.disabled = !state.choices.type; const dis = !state.choices.year; if(fInp) fInp.disabled = dis; if(fSel) fSel.disabled = dis; }
      tSel.addEventListener('change', (e)=>{ state.choices.type = e.target.value; setYears(); el('#openBtn').disabled = true; ySel.focus(); updateChips(); });
      ySel.addEventListener('change', (e)=>{ state.choices.year = e.target.value; setFacilities(); el('#openBtn').disabled = true; fInp.focus(); updateChips(); });
      fInp.addEventListener('input', (e)=>{ state.facFilter = e.target.value; setFacilities(); el('#openBtn').disabled = true; updateChips(); });
      fSel.addEventListener('change', (e)=>{ state.choices.slug = e.target.value; el('#openBtn').disabled = !(state.choices.slug); });
      el('#openBtn').addEventListener('click', openProfile);
      // Keyboard: Enter to advance or open
      document.addEventListener('keydown', (ev)=>{
        if ((ev.key||'') !== 'Enter') return;
        if (!state.choices.type) { tSel.focus(); return; }
        if (!state.choices.year) { ySel.focus(); return; }
        if (!state.choices.slug) { fInp.focus(); return; }
        if (!el('#openBtn').disabled) openProfile();
      });
      updateDisabled(); renderRecent();
    })();
  </script>
</body>
</html>
