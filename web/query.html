<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Query Assistant</title>
  <style>
    :root { --bg:#f7f9fc; --fg:#0b1220; --muted:#5f6b7a; --border:#e5eaf1; --accent:#0a58ca; }
    body { margin:0; background:var(--bg); color:var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { padding: 14px 16px; border-bottom: 1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
    main { padding: 16px; max-width: 1000px; margin: 0 auto; }
    .box { border:1px solid var(--border); border-radius:12px; background:#fff; padding:12px 14px; display:flex; gap:10px; align-items:center; }
    input { flex:1; border:none; outline:none; font-size:15px; }
    .btn { padding: 8px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; }
    .results { margin-top: 14px; }
    .card { border:1px solid var(--border); border-radius:10px; background:#fff; padding:10px 12px; margin:8px 0; }
    small { color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <strong>Query Assistant (beta)</strong>
    <a href="dashboard.html">Back to Dashboard</a>
  </header>
  <main>
    <div class="box">
      <input id="q" placeholder="Example: hospitals in Cook County in 2024 with city Chicago" />
      <button id="run" class="btn">Search</button>
    </div>
    <div id="hint"><small>Supported: type (Hospital/ASTC/ESRD/LTC), county/city/ZIP, and year. Advanced metrics coming later.</small></div>
    <div class="results" id="out"></div>
  </main>
  <script>
    const el = s => document.querySelector(s);
    const types = ['Hospital','ASTC','ESRD','LTC'];
    const stop = new Set(['in','of','the','for','with','and','to','at','on']);
    const yearRe = /(20\d{2}|19\d{2})/g;
    const zipRe = /\b\d{5}\b/;
    function parseQuery(text){
      const out = { type:'', year:'', county:'', city:'', zip:'' };
      const t = text.trim(); if (!t) return out;
      const y = t.match(yearRe); if (y) out.year = y.map(String).pop();
      const lower = t.toLowerCase();
      for (const ty of types) { if (lower.includes(ty.toLowerCase())) { out.type = ty; break; } }
      const zip = t.match(zipRe); if (zip) out.zip = zip[0];
      // crude county/city guess: pick capitalized tokens not types and not common words
      const words = t.split(/[^A-Za-z0-9]+/).filter(Boolean);
      const candidates = words.filter(w => w[0]===w[0].toUpperCase() && !types.includes(w) && !stop.has(w.toLowerCase()));
      if (candidates.length) {
        // If ends with 'County', set county; else city
        const joined = t;
        const m = /(\b[A-Z][a-zA-Z]+) County\b/.exec(joined);
        if (m) out.county = m[1]; else out.city = candidates[0];
      }
      return out;
    }
    async function loadIndex(){ const r = await fetch('data/index.json?v=2'); return await r.json(); }
    function fmtRow(r){
      const link = `./out/profiles/${r.year}/${r.type}/${r.slug}.html`;
      return `<div class=\"card\"><div><strong>${r.name}</strong> <small>• ${r.type} • ${r.city||''} ${r.zip||''} • ${r.year}</small></div><div><a class=\"btn\" href=\"${link}\" target=\"_blank\">Open Profile</a></div></div>`;
    }
    (async function(){
      const all = await loadIndex();
      function run(){
        const p = parseQuery(el('#q').value||'');
        let rows = all.slice();
        if (p.type) rows = rows.filter(r => r.type===p.type);
        if (p.year) rows = rows.filter(r => String(r.year)===String(p.year));
        if (p.zip) rows = rows.filter(r => String(r.zip||'').includes(p.zip));
        if (p.county) rows = rows.filter(r => (r.county||'').toLowerCase()===p.county.toLowerCase());
        if (p.city) rows = rows.filter(r => (r.city||'').toLowerCase().includes(p.city.toLowerCase()));
        el('#out').innerHTML = rows.length ? rows.slice(0,200).map(fmtRow).join('') : '<div class=\"card\">No matches found.</div>';
      }
      el('#run').addEventListener('click', run);
      el('#q').addEventListener('keydown', e => { if (e.key==='Enter') run(); });
    })();
  </script>
</body>
</html>
