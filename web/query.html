<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Query Assistant</title>
  <style>
    :root { --bg:#f7f9fc; --fg:#0b1220; --muted:#5f6b7a; --border:#e5eaf1; --accent:#28658D; }
    body { margin:0; background:var(--bg); color:var(--fg); font-family: Aptos, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { padding: 14px 16px; border-bottom: 1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
    main { padding: 16px; max-width: 1000px; margin: 0 auto; }
    .box { border:1px solid var(--border); border-radius:12px; background:#fff; padding:12px 14px; display:flex; gap:10px; align-items:center; }
    input { flex:1; border:none; outline:none; font-size:15px; }
    .btn { padding: 8px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; }
    .results { margin-top: 14px; }
    .card { border:1px solid var(--border); border-radius:10px; background:#fff; padding:10px 12px; margin:8px 0; }
    small { color: var(--muted); }
    #chips { margin-top:10px }
    #chips .chip { display:inline-block; margin: 0 6px 6px 0; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#fff; cursor:pointer; font-size:12px }
  </style>
</head>
<body>
  <header>
    <strong>Query Assistant (beta)</strong>
    <a href="dashboard.html">Back to Dashboard</a>
  </header>
  <main>
    <div class="box">
      <input id="q" placeholder="Example: hospitals in Cook County in 2024 with icu beds > 10" />
      <button id="run" class="btn">Search</button>
    </div>
    <div id="hint"><small>Supported: type (Hospital/ASTC/ESRD/LTC), county/city/ZIP, year, and metrics like “icu beds &gt; 10”, “stations &gt;= 20”, “rooms &lt; 5”, “visits 10000”.</small></div>
    <div id="count" style="margin-top:8px;color:#5f6b7a"></div>
    <div id="chips" style="margin-top:10px"></div>
    <div class="results" id="out"></div>
  </main>
  <script>
    const el = s => document.querySelector(s);
    const chipsBox = () => el('#chips');
    const types = ['Hospital','ASTC','ESRD','LTC'];
    const stop = new Set(['in','of','the','for','with','and','to','at','on']);
    const yearRe = /(20\d{2}|19\d{2})/g;
    const zipRe = /\b\d{5}\b/;
    function parseQuery(text){
      const out = { type:'', year:'', county:'', city:'', zip:'', metrics:[] };
      const t = text.trim(); if (!t) return out;
      const y = t.match(yearRe); if (y) out.year = y.map(String).pop();
      const lower = t.toLowerCase();
      for (const ty of types) { if (lower.includes(ty.toLowerCase())) { out.type = ty; break; } }
      const zip = t.match(zipRe); if (zip) out.zip = zip[0];
      // crude county/city guess: pick capitalized tokens not types and not common words
      const words = t.split(/[^A-Za-z0-9]+/).filter(Boolean);
      const candidates = words.filter(w => w[0]===w[0].toUpperCase() && !types.includes(w) && !stop.has(w.toLowerCase()));
      if (candidates.length) {
        // If ends with 'County', set county; else city
        const joined = t;
        const m = /(\b[A-Z][a-zA-Z]+) County\b/.exec(joined);
        if (m) out.county = m[1]; else out.city = candidates[0];
      }
      // numeric: e.g., "icu beds > 10", "stations >= 20", "rooms < 5", "visits 10000"
      const mexp = /(icu|ms|beds|stations|rooms|visits)\s*(?:beds|stations|rooms|visits)?\s*(>=|<=|>|<|=)?\s*(\d+)/gi;
      let mm; const map = { icu:'icu_beds', ms:'ms_beds', beds:'ms_beds', stations:'stations_setup', rooms:'or_rooms_class_c', visits:'op_visits_total' };
      while ((mm = mexp.exec(t))){ const k = map[mm[1].toLowerCase()]; const op = mm[2]||'='; const val = Number(mm[3]); if (k && Number.isFinite(val)) out.metrics.push({k,op,val}); }
      return out;
    }
    async function loadIndex(){ const r = await fetch('data/index.json?v=2'); return await r.json(); }
    function renderChips(p){
      const box = chipsBox();
      const parts = [];
      function chip(label, key){ if (!p[key]) return; parts.push(`<span class=\"chip\" data-k=\"${key}\">${label}: ${p[key]} ×</span>`); }
      chip('Type','type'); chip('Year','year'); chip('County','county'); chip('City','city'); chip('ZIP','zip');
      parts.push(`<button class=\"btn\" id=\"clearChips\">Clear</button>`);
      box.innerHTML = parts.join(' ');
      box.querySelectorAll('.chip').forEach(c => c.addEventListener('click', ()=>{ const k=c.getAttribute('data-k'); p[k]=''; runWith(p); }));
      const clr = el('#clearChips'); if (clr) clr.addEventListener('click', ()=>{ el('#q').value=''; run(); });
    }
    function runWith(p){
      renderChips(p);
      const all = window.__ALL__ || [];
      let rows = all.slice();
      if (p.type) rows = rows.filter(r => r.type===p.type);
      if (p.year) rows = rows.filter(r => String(r.year)===String(p.year));
      if (p.zip) rows = rows.filter(r => String(r.zip||'').includes(p.zip));
      if (p.county) rows = rows.filter(r => (r.county||'').toLowerCase()===p.county.toLowerCase());
      if (p.city) rows = rows.filter(r => (r.city||'').toLowerCase().includes(p.city.toLowerCase()));
      if (p.metrics && p.metrics.length){
        rows = rows.filter(r => {
          const m = r.metrics || {};
          return p.metrics.every(cond => {
            const val = m[cond.k]; if (val == null) return false;
            if (cond.op==='>') return val > cond.val;
            if (cond.op==='>=') return val >= cond.val;
            if (cond.op==='<') return val < cond.val;
            if (cond.op==='<=') return val <= cond.val;
            return Number(val) === Number(cond.val);
          });
        });
      }
      el('#out').innerHTML = rows.length ? rows.slice(0,200).map(fmtRow).join('') : '<div class=\"card\">No matches found.</div>';
    }
    function fmtRow(r){
      const link = `./out/profiles/${r.year}/${r.type}/${r.slug}.html`;
      return `<div class=\"card\"><div><strong>${r.name}</strong> <small>• ${r.type} • ${r.city||''} ${r.zip||''} • ${r.year}</small></div><div><a class=\"btn\" href=\"${link}\" target=\"_blank\">Open Profile</a></div></div>`;
    }
    (async function(){
      const all = await loadIndex(); window.__ALL__ = all;
      function run(){ const p = parseQuery(el('#q').value||''); runWith(p); const n=(el('#out').children||[]).length; el('#count').textContent = `${n} match${n==1?'':'es'}`; }
      el('#run').addEventListener('click', run);
      el('#q').addEventListener('keydown', e => { if (e.key==='Enter') run(); });
      let t=null; el('#q').addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(run, 220); });
    })();
  </script>
</body>
</html>
