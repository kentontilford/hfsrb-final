<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Query Assistant</title>
  <style>
    :root { --bg:#f7f9fc; --fg:#0b1220; --muted:#5f6b7a; --border:#e5eaf1; --accent:#28658D; }
    body { margin:0; background:var(--bg); color:var(--fg); font-family: Aptos, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { padding: 14px 16px; border-bottom: 1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
    main { padding: 16px; max-width: 1000px; margin: 0 auto; }
    .box { border:1px solid var(--border); border-radius:12px; background:#fff; padding:12px 14px; display:flex; gap:10px; align-items:center; }
    input { flex:1; border:none; outline:none; font-size:15px; }
    .btn { padding: 8px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; }
    .results { margin-top: 14px; }
    .card { border:1px solid var(--border); border-radius:10px; background:#fff; padding:10px 12px; margin:8px 0; }
    small { color: var(--muted); }
    #chips { margin-top:10px }
    #chips .chip { display:inline-block; margin: 0 6px 6px 0; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#fff; cursor:pointer; font-size:12px }
  </style>
</head>
<body>
  <header>
    <strong>Query Assistant (beta)</strong>
    <a href="dashboard.html">Back to Dashboard</a>
  </header>
  <main>
    <div class="box">
      <input id="q" placeholder="Example: hospitals in Cook County in 2024 with icu beds > 10" />
      <button id="run" class="btn">Search</button>
    </div>
    <div id="hint"><small>Ask for filters and columns, e.g. “hospitals in Cook County in 2024 with icu beds &gt; 10; show name, city, icu beds”.</small></div>
    <div id="interp" class="card" style="display:none"></div>
    <div id="count" style="margin-top:8px;color:#5f6b7a"></div>
    <div class="results" id="out"></div>
  </main>
  <script>
    const el = s => document.querySelector(s);
    const FIELD_MAP = {
      name:'name', city:'city', county:'county', zip:'zip', year:'year', type:'type',
      'icu beds':'metrics.icu_beds','ms beds':'metrics.ms_beds','op visits':'metrics.op_visits_total',
      'or rooms':'metrics.or_rooms_total','or cases':'metrics.or_cases_total','class c cases':'metrics.or_cases_class_c','class b cases':'metrics.or_cases_class_b',
      'ed visits':'metrics.ed_visits','stations':'metrics.stations_setup','fte total':'metrics.fte_total','rooms exam':'metrics.rooms_exam',
      'idd beds':'metrics.beds_licensed_idd','idd days':'metrics.days_total_idd',
      'medicare':'metrics.pay_medicare','medicaid':'metrics.pay_medicaid','private insurance':'metrics.pay_private_ins','other public':'metrics.pay_other_public','private pay':'metrics.pay_private_pay'
    };
    const types = ['Hospital','ASTC','ESRD','LTC'];
    const stop = new Set(['in','of','the','for','with','and','to','at','on']);
    const yearRe = /(20\d{2}|19\d{2})/g;
    const zipRe = /\b\d{5}\b/;
    function parseQuery(text){
      const out = { type:'', year:'', county:'', city:'', zip:'', metrics:[], columns:[] };
      const t = text.trim(); if (!t) return out;
      const y = t.match(yearRe); if (y) out.year = y.map(String).pop();
      const lower = t.toLowerCase();
      for (const ty of types) { if (lower.includes(ty.toLowerCase())) { out.type = ty; break; } }
      const zip = t.match(zipRe); if (zip) out.zip = zip[0];
      // crude county/city guess: pick capitalized tokens not types and not common words
      const words = t.split(/[^A-Za-z0-9]+/).filter(Boolean);
      const candidates = words.filter(w => w[0]===w[0].toUpperCase() && !types.includes(w) && !stop.has(w.toLowerCase()));
      if (candidates.length) {
        // If ends with 'County', set county; else city
        const joined = t;
        const m = /(\b[A-Z][a-zA-Z]+) County\b/.exec(joined);
        if (m) out.county = m[1]; else out.city = candidates[0];
      }
      // numeric: e.g., "icu beds > 10", "stations >= 20", "rooms < 5", "visits 10000"
      const mexp = /(icu|ms|beds|stations|rooms|visits)\s*(?:beds|stations|rooms|visits)?\s*(>=|<=|>|<|=)?\s*(\d+)/gi;
      let mm; const map = { icu:'icu_beds', ms:'ms_beds', beds:'ms_beds', stations:'stations_setup', rooms:'or_rooms_class_c', visits:'op_visits_total' };
      while ((mm = mexp.exec(t))){ const k = map[mm[1].toLowerCase()]; const op = mm[2]||'='; const val = Number(mm[3]); if (k && Number.isFinite(val)) out.metrics.push({k,op,val}); }
      // columns
      const mcols = /(show|list)\s+([a-z0-9 ,_]+)$/i.exec(t);
      if (mcols){ out.columns = mcols[2].split(/[, ]+/).map(x=>x.trim().toLowerCase()).filter(Boolean); }
      return out;
    }
    async function loadIndex(){ const r = await fetch('data/index.json?v=2'); return await r.json(); }
    function renderInterp(p){
      const box = el('#interp'); if (!box) return;
      const chips = [];
      function chip(label, key){ if (!p[key]) return; chips.push(`<span class=\"chip\">${label}: ${p[key]}</span>`); }
      chip('Type','type'); chip('Year','year'); chip('County','county'); chip('City','city'); chip('ZIP','zip');
      if (p.metrics && p.metrics.length) chips.push(...p.metrics.map(c=>`<span class=\"chip\">${c.k} ${c.op} ${c.val}</span>`));
      const cols = (p.columns||[]).map(c=>`<span class=\"chip\">${c}</span>`).join(' ');
      box.innerHTML = `<div><small>Filters:</small> ${chips.join(' ')||'<em>none</em>'}</div>` + (cols? `<div style=\"margin-top:6px\"><small>Columns:</small> ${cols}</div>`:'') + `<div style=\"margin-top:6px\"><button class=\"btn\" id=\"clearAll\">Clear</button></div>`;
      box.style.display='block';
      const clr = el('#clearAll'); if (clr) clr.addEventListener('click', ()=>{ el('#q').value=''; run(); });
    }
    function runWith(p){
      renderInterp(p);
      const all = window.__ALL__ || [];
      let rows = all.slice();
      if (p.type) rows = rows.filter(r => r.type===p.type);
      if (p.year) rows = rows.filter(r => String(r.year)===String(p.year));
      if (p.zip) rows = rows.filter(r => String(r.zip||'').includes(p.zip));
      if (p.county) rows = rows.filter(r => (r.county||'').toLowerCase()===p.county.toLowerCase());
      if (p.city) rows = rows.filter(r => (r.city||'').toLowerCase().includes(p.city.toLowerCase()));
      if (p.metrics && p.metrics.length){
        rows = rows.filter(r => {
          const m = r.metrics || {};
          return p.metrics.every(cond => {
            const val = m[cond.k]; if (val == null) return false;
            if (cond.op==='>') return val > cond.val;
            if (cond.op==='>=') return val >= cond.val;
            if (cond.op==='<') return val < cond.val;
            if (cond.op==='<=') return val <= cond.val;
            return Number(val) === Number(cond.val);
          });
        });
      }
      // projection
      const cols = (p.columns && p.columns.length) ? p.columns : ['name','city','year'];
      const resolved = cols.map(c => ({ key:c, path:FIELD_MAP[c]||c }));
      const header = `<tr>${resolved.map(r=>`<th style=\"text-align:left;border-bottom:1px solid #e5eaf1;padding:6px\">${r.key.toUpperCase()}</th>`).join('')}</tr>`;
      function get(obj, path){ const parts=String(path||'').split('.'); let cur=obj; for(const pr of parts){ if(!cur) return ''; cur = cur[pr]; } return cur==null?'':cur; }
      const body = rows.slice(0,200).map(r=>`<tr>${resolved.map(c=>`<td style=\"padding:6px;border-bottom:1px solid #f0f2f6\">${get(r, c.path)}</td>`).join('')}</tr>`).join('');
      const table = `<div class=\"card\"><div style=\"display:flex;justify-content:space-between;align-items:center\"><strong>${rows.length} matches</strong><button id=\"dlCsv\" class=\"btn\">Download CSV</button></div><table style=\"width:100%;border-collapse:collapse;margin-top:6px\">${header}${body}</table></div>`;
      el('#out').innerHTML = rows.length ? table : '<div class=\"card\">No matches found.</div>';
      const btn = el('#dlCsv'); if (btn) btn.addEventListener('click', ()=>{
        const csv = [cols.map(h=>`"${h.replace(/"/g,'""')}"`).join(',')]
          .concat(rows.map(r=> cols.map(c=>`"${String(get(r, FIELD_MAP[c]||c)??'').replace(/"/g,'""')}"`).join(',')))
          .join('\n');
        const blob = new Blob([csv], {type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='query-results.csv'; document.body.appendChild(a); a.click(); a.remove();
      });
    }
    function fmtRow(r){
      const link = `./out/profiles/${r.year}/${r.type}/${r.slug}.html`;
      return `<div class=\"card\"><div><strong>${r.name}</strong> <small>• ${r.type} • ${r.city||''} ${r.zip||''} • ${r.year}</small></div><div><a class=\"btn\" href=\"${link}\" target=\"_blank\">Open Profile</a></div></div>`;
    }
    (async function(){
      const all = await loadIndex(); window.__ALL__ = all;
      function run(){ const p = parseQuery(el('#q').value||''); runWith(p); const n=(el('#out').children||[]).length; el('#count').textContent = `${n} match${n==1?'':'es'}`; }
      el('#run').addEventListener('click', run);
      el('#q').addEventListener('keydown', e => { if (e.key==='Enter') run(); });
      let t=null; el('#q').addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(run, 220); });
    })();
  </script>
</body>
</html>
